version: "3.9"

services:
  api:
    build: ./api
    container_name: benchmaker_api
    ports:
      - "8000:8000"
    environment:
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_EXPORTER_OTLP_INSECURE: "true"
      OTEL_SERVICE_NAME: "benchmaker-lite-api"
    depends_on:
      - clickhouse
      - otel-collector

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: benchmaker_clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - ./clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql
    
    environment:
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: benchmaker
      CLICKHOUSE_DB: default

      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/?query=SELECT%201"]
      interval: 5s
      timeout: 3s
      retries: 10

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: benchmaker_otel_collector
    command: ["--config=/otel-local-config.yaml"]
    volumes:
      - ./otel/collector-config.yaml:/otel-local-config.yaml
      - ./otel/logs:/otel-collector/logs   # <â€” shared folder for logs
    ports:
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP HTTP receiver
    depends_on:
      [clickhouse]
      # condition: service_healthy
